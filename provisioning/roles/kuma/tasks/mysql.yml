---
- name: Check if utf8_distinct_ci collation is already installed
  shell: grep "utf8_distinct_ci" /usr/share/mysql/charsets/Index.xml
  register: utf8_distinct_ci_found
  ignore_errors: True

- name: Find out the max collation ID of the database
  shell: >
    /usr/bin/mysql -uroot -p{{ mysql_root_password }}
    -e "SELECT MAX(ID) FROM INFORMATION_SCHEMA.COLLATIONS;" | head -2 | tail -1
  register: max_collation_id
  when: utf8_distinct_ci_found|failed

- name: Store max_collation_id in a fact
  set_fact: collation_id="{{ max_collation_id.stdout|int + 1 }}"
  when: utf8_distinct_ci_found|failed

- name: Copy collation index
  template:
    src: Index.xml.j2
    dest: /usr/share/mysql/charsets/Index.xml
    owner: root
    group: root
    backup: yes
  when: utf8_distinct_ci_found|failed

- name: Ensure MySQL is restarted after collation installation.
  service: name=mysql state=restarted sleep=5
  when: utf8_distinct_ci_found|failed
